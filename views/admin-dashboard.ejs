<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin Dashboard</title>
    <link rel="stylesheet" href="/css/layout.css">
    <link rel="stylesheet" href="/css/admin-dashboard.css">
</head>

<body>
    <nav class="navbar">
        <div class="nav-container">
            <h1 class="nav-title">Admin Dashboard</h1>
            <div class="nav-links">
                <span>Welcome, <%= user.username %> (Admin)</span>
                <a href="/logout">Logout</a>
            </div>
        </div>
    </nav>

    <div class="admin-container">
        <div class="admin-header">
            <h2>Admin Panel</h2>
        </div>

        <div class="admin-grid">
            <!-- All Users -->
            <div class="admin-card">
                <h3>All Users</h3>
                <div class="users-list">
                    <% if (users && users.length> 0) { %>
                        <% users.forEach(user=> { %>
                            <div class="user-item">
                                <div class="user-info">
                                    <strong>
                                        <%= user.username %>
                                    </strong>
                                    <span>
                                        <%= user.email %>
                                    </span>
                                </div>
                                <div class="user-actions">
                                    <button class="message-btn"
                                        onclick="showMessageForm('<%= user._id %>', '<%= user.username %>')">
                                        Send Message
                                    </button>
                                    <button class="history-btn"
                                        onclick="showConversationHistory('<%= user._id %>', '<%= user.username %>')">
                                        View History
                                    </button>
                                </div>
                            </div>
                            <% }) %>
                                <% } else { %>
                                    <p class="no-data">No users found</p>
                                    <% } %>
                </div>
            </div>

            <!-- All Uploads -->
            <div class="admin-card">
                <h3>All User Uploads</h3>
                <div class="uploads-list">
                    <% if (uploads && uploads.length> 0) { %>
                        <% uploads.forEach(upload=> { %>
                            <div class="upload-item">
                                <div class="upload-info">
                                    <strong>
                                        <%= upload.originalName %>
                                    </strong>
                                    <span class="upload-user">By: <%= upload.userId.username %></span>
                                    <span class="upload-type">
                                        <%= upload.fileType %>
                                    </span>
                                    <span class="upload-date">
                                        <%= upload.createdAt.toLocaleDateString() %>
                                    </span>
                                </div>

                                <!-- Media Preview -->
                                <% if (upload.mimeType.startsWith('image/')) { %>
                                    <div class="media-preview">
                                        <img src="/upload/file/<%= upload._id %>" alt="<%= upload.originalName %>"
                                            class="preview-image">
                                    </div>
                                    <% } else if (upload.mimeType.startsWith('video/')) { %>
                                        <div class="media-preview">
                                            <video controls class="preview-video">
                                                <source src="/upload/file/<%= upload._id %>"
                                                    type="<%= upload.mimeType %>">
                                                Your browser does not support the video tag.
                                            </video>
                                        </div>
                                        <% } %>

                                            <div class="upload-actions">
                                                <a href="/upload/file/<%= upload._id %>" target="_blank"
                                                    class="view-btn">View</a>
                                                <a href="/upload/download/<%= upload._id %>"
                                                    class="download-btn">Download</a>
                                            </div>
                            </div>
                            <% }) %>
                                <% } else { %>
                                    <p class="no-data">No uploads found</p>
                                    <% } %>
                </div>
            </div>

            <!-- Send Message Form -->
            <div class="admin-card" id="messageCard" style="display: none;">
                <h3>Send Message to User</h3>
                <form action="/message/send" method="POST" enctype="multipart/form-data" class="message-form">
                    <input type="hidden" id="receiverId" name="receiverId">
                    <div class="form-group">
                        <label>To: <span id="receiverName"></span></label>
                    </div>
                    <div class="form-group">
                        <label for="message">Message:</label>
                        <textarea id="message" name="message" rows="4" required></textarea>
                    </div>
                    <div class="form-group">
                        <label for="file">Attach File (optional):</label>
                        <input type="file" id="file" name="file">
                    </div>
                    <div class="form-actions">
                        <button type="submit">Send Message</button>
                        <button type="button" onclick="hideMessageForm()">Cancel</button>
                    </div>
                </form>
            </div>

            <!-- Conversation History Modal -->
            <div class="admin-card" id="historyCard" style="display: none;">
                <h3>Conversation History with <span id="historyUserName"></span></h3>
                <div class="conversation-history" id="conversationHistory">
                    <!-- Messages will be loaded here -->
                </div>
                <div class="form-actions">
                    <button type="button" onclick="hideHistoryModal()">Close</button>
                </div>
            </div>
        </div>
    </div>

    <script>
        function showMessageForm(userId, username) {
            document.getElementById('receiverId').value = userId;
            document.getElementById('receiverName').textContent = username;
            document.getElementById('messageCard').style.display = 'block';
            document.getElementById('historyCard').style.display = 'none';
        }

        function hideMessageForm() {
            document.getElementById('messageCard').style.display = 'none';
            document.getElementById('message').value = '';
            document.getElementById('file').value = '';
        }

        async function showConversationHistory(userId, username) {
            document.getElementById('historyUserName').textContent = username;
            document.getElementById('historyCard').style.display = 'block';
            document.getElementById('messageCard').style.display = 'none';

            try {
                const response = await fetch(`/message/conversation/${userId}`);
                const messages = await response.json();

                const historyDiv = document.getElementById('conversationHistory');
                historyDiv.innerHTML = '';

                if (messages.length === 0) {
                    historyDiv.innerHTML = '<p class="no-data">No conversation history</p>';
                    return;
                }

                messages.forEach(message => {
                    const messageDiv = document.createElement('div');
                    messageDiv.className = 'history-message';

                    const isFromAdmin = message.senderId.username !== username;
                    messageDiv.classList.add(isFromAdmin ? 'admin-message' : 'user-message');

                    messageDiv.innerHTML = `
                        <div class="message-header">
                            <strong>${message.senderId.username}</strong>
                            <span class="message-date">${new Date(message.createdAt).toLocaleString()}</span>
                        </div>
                        <div class="message-content">${message.message}</div>
                        ${message.file ? `<div class="message-file"><a href="/${message.file}" target="_blank">View Attachment</a></div>` : ''}
                    `;

                    historyDiv.appendChild(messageDiv);
                });

                // Scroll to bottom
                historyDiv.scrollTop = historyDiv.scrollHeight;
            } catch (error) {
                console.error('Error loading conversation:', error);
                document.getElementById('conversationHistory').innerHTML = '<p class="error-message">Error loading conversation</p>';
            }
        }

        function hideHistoryModal() {
            document.getElementById('historyCard').style.display = 'none';
        }
    </script>
</body>

</html>